name: Node.js CI

on: [pull_request]

jobs:
  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      TURBO_SCM_BASE: ${{ github.event.pull_request.base.sha }}
      TURBO_SCM_HEAD: ${{ github.event.pull_request.head.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-pr-${{ hashFiles('package-lock.json') }}-${{ github.job }}-${{ github.event.pull_request.head.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-pr-${{ hashFiles('package-lock.json') }}-${{ github.job }}-
            ${{ runner.os }}-turbo-pr-${{ hashFiles('package-lock.json') }}-
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: npm
          cache-dependency-path: package-lock.json
      - run: npm ci --include=optional
      - run: npm run typecheck

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    env:
      TURBO_SCM_BASE: ${{ github.event.pull_request.base.sha }}
      TURBO_SCM_HEAD: ${{ github.event.pull_request.head.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-pr-${{ hashFiles('package-lock.json') }}-${{ github.job }}-${{ github.event.pull_request.head.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-pr-${{ hashFiles('package-lock.json') }}-${{ github.job }}-
            ${{ runner.os }}-turbo-pr-${{ hashFiles('package-lock.json') }}-
      - name: Detect changed areas
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            cli:
              - "apps/cli/**"
              - "packages/sdk/**"
              - "packages/lib/**"
              - "packages/std/**"
              - "packages/compiler/**"
              - "packages/js-host/**"
              - "scripts/voyd"
              - "turbo.json"
              - "package-lock.json"
              - "vite.config.ts"
              - "vitest.config.ts"
              - "tsconfig*.json"
            compiler_semantics:
              - "packages/compiler/src/semantics/**"
            non_cli_build:
              - "apps/site/**"
              - "apps/vscode/**"
              - "packages/reference/**"
              - "package-lock.json"
              - "turbo.json"
              - "tsconfig*.json"
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: npm
          cache-dependency-path: package-lock.json
      - run: npm ci --include=optional
      # Main PR tests run in source mode for speed and broad coverage.
      - run: VOYD_USE_SRC=1 npx turbo run test --affected --output-logs=errors-only --concurrency=75%
      # Build-only checks for non-CLI artifacts that are not exercised by package tests.
      - name: Build non-CLI artifacts
        if: steps.changes.outputs.non_cli_build == 'true'
        # Turbo (2.6.x) rejects combining --affected with --filter, so scope by this step guard
        # and keep affected package selection inside turbo.
        run: npx turbo run build --affected --output-logs=errors-only
      # Dist mode is validated separately via targeted CLI e2e when CLI/runtime areas change.
      - name: Build CLI dist for dist e2e
        if: steps.changes.outputs.cli == 'true'
        run: npx turbo run build --filter=@voyd/cli... --output-logs=errors-only
      - name: Run CLI dist e2e
        if: steps.changes.outputs.cli == 'true'
        run: VOYD_USE_DIST=1 VOYD_CLI_E2E_RUNTIME=dist npm run --workspace @voyd/cli test -- src/__tests__/cli-e2e.test.ts
      - name: Run typing benchmark regression gate
        if: steps.changes.outputs.compiler_semantics == 'true'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          TYPING_BENCH_MAX_REGRESSION_PCT: "15"
        run: node scripts/ci/check-typing-bench-regression.mjs
