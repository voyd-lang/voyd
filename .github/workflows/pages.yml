name: Deploy site

on:
  push:
    branches: [main]
    paths:
      - "apps/site/**"
      - "apps/cli/**"
      - "packages/compiler/**"
      - "packages/reference/**"
      - "packages/sdk/**"
      - "packages/std/**"
      - ".github/workflows/pages.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/configure-pages@v5
        id: pages

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Set Turbo SCM range
        run: |
          ZERO_SHA="0000000000000000000000000000000000000000"
          BEFORE_SHA="${{ github.event.before }}"
          if [ -n "$BEFORE_SHA" ] && [ "$BEFORE_SHA" != "$ZERO_SHA" ]; then
            echo "TURBO_SCM_BASE=$BEFORE_SHA" >> "$GITHUB_ENV"
          else
            BASE_FALLBACK="$(git rev-parse HEAD^ 2>/dev/null || git rev-parse HEAD)"
            echo "TURBO_SCM_BASE=$BASE_FALLBACK" >> "$GITHUB_ENV"
          fi
          echo "TURBO_SCM_HEAD=${{ github.sha }}" >> "$GITHUB_ENV"

      - run: npm ci --include=optional

      - name: Generate std docs
        run: |
          mkdir -p apps/site/public/std
          VOYD_USE_SRC=1 npx tsx --conditions=development apps/cli/src/cli-dev.ts doc packages/std/src --format html --out apps/site/public/std/index.html

      - name: Build
        env:
          GITHUB_PAGES_BASE_PATH: ${{ steps.pages.outputs.base_path }}
        run: npm run build

      - uses: actions/upload-pages-artifact@v3
        with:
          path: apps/site/build/client${{ steps.pages.outputs.base_path }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/deploy-pages@v4
        id: deployment
